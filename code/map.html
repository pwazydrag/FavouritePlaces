<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map</title>
    <link rel = "stylesheet" href = "http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
    <script src = "http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
    <script type="firebase.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="../css/style.css">
  </head>
<body>
  <nav class="navbar navbar-dark bg-dark navbar-expand-xxl">
    <div class="container-fluid">
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainmenu"><span class="navbar-toggler-icon"></span></button>
    </div>
</nav>
            

<div id = "map" style = "width: 100%; height: 90vh"></div>


<script type="module">

  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js"
  import { getFirestore } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js'
  import { collection, getDocs, doc, addDoc } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js'
  import { getDatabase, ref, set } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js'

  const firebaseConfig = {
      apiKey: "AIzaSyBaJS4R0Dx7VA8v93VeOjIuuwRzM7uKceo",
      authDomain: "favouriteplaces-de573.firebaseapp.com",
      projectId: "favouriteplaces-de573",
      storageBucket: "favouriteplaces-de573.appspot.com",
      messagingSenderId: "744396835300",
      appId: "1:744396835300:web:295e15f2af025cf704dff1",
      measurementId: "G-ENRZEZS1KZ"
  };

  const app = initializeApp(firebaseConfig);

  const db = getFirestore(app);
  const querySnapshot = await getDocs(collection(db,"places"));


  getLocation();
 

  function getLocation() {
  if (navigator.geolocation) {
     navigator.geolocation.getCurrentPosition(showPosition);
   } else {
      x.innerHTML = "Geolocation is not supported by this browser.";
    }}

  function showPosition(position) {
    var pos_latitude = position.coords.latitude
    var pos_longitude = position.coords.longitude

    var mapOptions = {
      center: [pos_latitude, pos_longitude],
      attributionControl : false,
      zoom: 18}

    var map = new L.map('map', mapOptions);
    var layer = new L.TileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
    map.addLayer(layer);

    var attrOptions = {
      prefix: 'UlubioneMiejsca'
      };
       
       var attr = L.control.attribution(attrOptions);
       attr.addTo(map);  

      map.on("click", function(e){
        if (confirm("Czy chcesz dodać w tym miejscu nowy punkt?") == true ){
          var newPlaceName = prompt("Podaj nazwę nowego punktu:");
          if (newPlaceName != null && newPlaceName !=""){
            var newPlaceDescription = prompt("Podaj opis nowego miejsca:")
            if (newPlaceDescription != null && newPlaceDescription !=""){
              var newPlaceLatitude = e.latlng.lat;
              var newPlaceLongitude = e.latlng.lng;
              var markerOptions = {
                title: newPlaceName,
                clickable: true,
                draggable: false
             }
            var marker = L.marker([newPlaceLatitude, newPlaceLongitude], markerOptions);
            marker.bindPopup(newPlaceDescription);
            marker.addTo(map);

            addDoc(collection(db, "places"), {
              name: newPlaceName,
              latitude: newPlaceLatitude,
              longitude: newPlaceLongitude,
              favourite: false,
              description: newPlaceDescription
              });
        }
        }
        }
        })
        
    addExistingPointsFromFirebase();

      function addExistingPointsFromFirebase(){
        querySnapshot.forEach((doc) => {
         if (doc.data()['favourite']==true){
          var iconOptions = {
            iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
          }
          var customIcon = L.icon(iconOptions);
          var markerOptions = {
            title: doc.data()['name'],
            clickable: true,
            draggable: false,
            icon:customIcon
         }
         }
         else{
          var markerOptions = {
            title: doc.data()['name'],
            clickable: true,
            draggable: false,
         } 
         }
          var marker = L.marker([doc.data()['latitude'], doc.data()['longitude']], markerOptions);
          marker.bindPopup(doc.data()['description'])
          marker.addTo(map);
        });
      }
    }

    
</script>

</body>
</html>