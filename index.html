<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel = "stylesheet" href = "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" />
    <script src = "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
    <script type="firebase.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="css/style.css">
    <title>Menu</title>
    <script src="https://unpkg.com/vue@3"></script>
</head>
<body> 

    <div id="app">

    <!-- Template Navbar -->
    <template v-if="currentView.show_navbar">
        <nav class="navbar navbar-dark bg-dark navbar-expand-xxl">
            <div class="container-fluid">
              <button @click="renderMenu()" class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainmenu"><span class="navbar-toggler-icon"></span></button>
            </div>
        </nav>
    </template>

    <!-- Widok menu -->
    <template v-if="currentView.show_menu">
        <div class="col-12" id="menuTop">
            <div class="col-6">
                <h3 id="menuAppName">{{ menuElements.name }}</h3>
                <h4 class="menuTopElement">{{ menuElements.login }}</h4>          <!-- tutaj wstawić login zalogowanego na przykład -->
            </div>
        </div>
        <div class="col-12" id="menuBot">
            <h4 id="menuMenu">{{ menuElements.menu }}</h4>
            <h4 @click="renderList()" class="menuElement">{{ menuElements.list }}</h4>
            <h4 @click="renderMap()" class="menuElement">{{ menuElements.map }}</h4>
            <h4 @click="renderAddForm()" class="menuElement">{{ menuElements.add}}</h4>
            <h4 class="menuElement">{{ menuElements.logout }}</h4>
        </div>
    </template>

    <!-- Widok listy lokalizacji -->
    <template v-if="currentView.show_list">
        <div class="container-fluid" style="background-color: white;">
            <div id="list"></div>
        </div>
        
        <div class="container-fluid" id="details" style="display: none;">
            <form>
                <label for="inputName" class="mt-3">Nazwa</label>
                <input type="text" class="form-control" id="inputName" value="" required>
                <label for="inputDescription" class="mt-3">Opis</label>
                <textarea id="inputDescription" cols="50" rows="12" class="w-100" required></textarea>
                <label for="inputLatitude" class="mt-3">Szerokość geograficzna</label>
                <input type="text" class="form-control" id="inputLatitude" value="" required>
                <label for="inputLongitude" class="mt-3">Długość geograficzna</label>
                <input type="text" class="form-control" id="inputLongitude" value="" required>
                <p class="mt-3">Ulubione</p>
                <div>
                    <input type="radio" id="inputFavouriteYes" value="yes" name="favouriteRadio">
                    <label for="inputFavouriteYes">Tak</label>
                    <input type="radio" id="inputFavouriteNo" value="no" name="favouriteRadio">
                    <label for="inputFavouriteNo">Nie</label>
                </div>
                <div class="mt-3">
                    <button type="button" value="Submit" id="btn" class="btn btn-primary" @click="submitChanges()">Zapisz zmiany</button>
                </div>
            </form>
        </div>
    </template>

    <!-- Widok mapy z menu -->
    <template v-if="currentView.show_map">
        <div id = "map" style = "width: 100%; height: 90vh"></div>
    </template>

    <!-- Widok dodawania nowej lokalizacji -->
    <template v-if="currentView.show_add_form">
        <div class="col-12" id="menuTop">
            <h4 style="color: white;">Dodaj lokalizacje</h4>
        </div>
    </template>




    </div>
    
    <script type="module">

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js"
        import { getFirestore, collection, getDocs, doc, addDoc, query, where, updateDoc } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js'
        import { getDatabase, ref, set } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js'
      
        const firebaseConfig = {
            apiKey: "AIzaSyBaJS4R0Dx7VA8v93VeOjIuuwRzM7uKceo",
            authDomain: "favouriteplaces-de573.firebaseapp.com",
            projectId: "favouriteplaces-de573",
            storageBucket: "favouriteplaces-de573.appspot.com",
            messagingSenderId: "744396835300",
            appId: "1:744396835300:web:295e15f2af025cf704dff1",
            measurementId: "G-ENRZEZS1KZ"
        };
      
    const app = initializeApp(firebaseConfig);







    Vue.createApp({
            data() {
                return {
                    // narazie statyczne
                    user: 'user1',
                    localization: 'loc1',

                    localization_id: '',
                    menuElements: {
                        name: "UlubioneLokalizacje",
                        login: "jankowalski",
                        menu: "Menu",
                        list: "Lista lokalizacji",
                        map: "Mapa",
                        add: "Dodaj lokalizację",
                        logout: "Wyloguj się",
                    },
                    currentView: {
                        show_navbar: false,
                        show_menu: true,
                        show_list: false,
                        show_detail: false,
                        show_map: false,
                        show_add_form: false,
                    }
                }
            },
            methods: {
                hideAll() {
                    this.currentView.show_navbar = false
                    this.currentView.show_menu = false
                    this.currentView.show_list = false
                    this.currentView.show_detail = false
                    this.currentView.show_map = false
                    this.currentView.show_add_form = false
                },
                renderList() {
                    this.hideAll()
                    this.currentView.show_navbar = true
                    this.currentView.show_list = true
                    this.listjs()
                },
                renderMap() {
                    this.hideAll()
                    this.currentView.show_navbar = true
                    this.currentView.show_map = true
                    this.mapjs()
                },
                renderAddForm() {
                    this.hideAll()
                    this.currentView.show_navbar = true
                    this.currentView.show_add_form = true
                },
                renderMenu() {
                    this.hideAll()
                    this.currentView.show_menu = true
                },




                selectElementId: function(event) {
            var targetId = event.currentTarget.id;
            this.localization_id = targetId
            this.showDetails(targetId)
        },

                async showDetails(targetId){
                    const db = getFirestore(app);
    const querySnapshot = await getDocs(collection(db,"places"));

        var elementId = this.localization_id;
        var allItems = document.getElementsByClassName("listSingleItem")
        var item = "";
        for (var i=0; i<allItems.length; i++){
            allItems[i].style.display='none';
        }
        var detailsPage = document.getElementById('details');
        detailsPage.style.display='block';
        querySnapshot.forEach((doc) => {
            if (doc.id==elementId){
                document.getElementById("inputName").value=doc.data()['name'];
                document.getElementById("inputDescription").value=doc.data()['description'];
                document.getElementById("inputLatitude").value=doc.data()['latitude'];
                document.getElementById("inputLongitude").value=doc.data()['longitude'];
                if (doc.data()['favourite']==true){
                    document.getElementById("inputFavouriteYes").checked=true;
                }
                else{
                    document.getElementById("inputFavouriteNo").checked=true;
                }
            }
        });
    },

    async submitChanges(event) {
        const db = getFirestore(app);
        var changedName = document.getElementById("inputName").value;
        var changedDescription = document.getElementById("inputDescription").value;
        var changedLatitude = document.getElementById("inputLatitude").value;
        var changedLongitude = document.getElementById("inputLongitude").value;
        if (document.getElementById("inputFavouriteYes").checked==true){
            var changedFavourite = true;
        }
        else {
            var changedFavourite = false;
        }
        
        const plRef = doc(db, "places", this.localization_id);
        await updateDoc(plRef, {
        name: changedName,
        description: changedDescription,
        latitude: changedLatitude,
        longitude: changedLongitude,
        favourite: changedFavourite

});
    },

    
        

    

// JavaScript dla listy
                async listjs() {
                    
    const db = getFirestore(app);
    const querySnapshot = await getDocs(collection(db,"places"));
    var el = document.getElementById("list")

    querySnapshot.forEach((doc) => {
        var newDiv = document.createElement("div");
        var newTitle = document.createElement("h4");
        var newDescription = document.createElement("h6");
        newDiv.setAttribute('id', doc.id);
        newDiv.className="listSingleItem";
        newDiv.addEventListener('click', this.selectElementId);
        newTitle.innerHTML = doc.data()['name'];
        newDescription.innerHTML = doc.data()['description'];
        newTitle.className="listSingleItemName";
        newDescription.className="listSingleItemDescription";
        newDiv.appendChild(newTitle);
        newDiv.appendChild(newDescription);
        el.appendChild(newDiv);
    });

                },

// JavaScript dla mapy
                async mapjs() {
                    const db = getFirestore(app);
                    const querySnapshot = await getDocs(collection(db,"places"));

                    getLocation();
                    
                    function getLocation() {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(showPosition);
                    } else {
                        x.innerHTML = "Geolocation is not supported by this browser.";
                        }}

                    function showPosition(position) {
                        var pos_latitude = position.coords.latitude
                        var pos_longitude = position.coords.longitude

                        var mapOptions = {
                        center: [pos_latitude, pos_longitude],
                        attributionControl : false,
                        zoom: 18}

                        var map = new L.map('map', mapOptions);
                        var layer = new L.TileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
                        map.addLayer(layer);

                        var attrOptions = {
                        prefix: 'UlubioneMiejsca'
                        };
                        
                        var attr = L.control.attribution(attrOptions);
                        attr.addTo(map);  

                        map.on("click", function(e){
                            if (confirm("Czy chcesz dodać w tym miejscu nowy punkt?") == true ){
                            var newPlaceName = prompt("Podaj nazwę nowego punktu:");
                                if (newPlaceName != null && newPlaceName !=""){
                                    var newPlaceDescription = prompt("Podaj opis nowego miejsca:")
                                    if (newPlaceDescription != null && newPlaceDescription !=""){
                                    var newPlaceLatitude = e.latlng.lat;
                                    var newPlaceLongitude = e.latlng.lng;
                                    var markerOptions = {
                                        title: newPlaceName,
                                        clickable: true,
                                        draggable: false
                                    }
                                    var marker = L.marker([newPlaceLatitude, newPlaceLongitude], markerOptions);
                                    marker.bindPopup(newPlaceDescription);
                                    marker.addTo(map);

                                    addDoc(collection(db, "places"), {
                                    name: newPlaceName,
                                    latitude: newPlaceLatitude,
                                    longitude: newPlaceLongitude,
                                    favourite: false,
                                    description: newPlaceDescription
                                    });
                                }
                            }
                        }
                        })
        
                    addExistingPointsFromFirebase();

                    function addExistingPointsFromFirebase(){
                        querySnapshot.forEach((doc) => {
                        if (doc.data()['favourite']==true){
                        var iconOptions = {
                            iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        }
                        var customIcon = L.icon(iconOptions);
                        var markerOptions = {
                            title: doc.data()['name'],
                            clickable: true,
                            draggable: false,
                            icon:customIcon
                        }
                        }
                        else{
                        var markerOptions = {
                            title: doc.data()['name'],
                            clickable: true,
                            draggable: false,
                        } 
                        }
                        var marker = L.marker([doc.data()['latitude'], doc.data()['longitude']], markerOptions);
                        marker.bindPopup(doc.data()['description'])
                        marker.addTo(map);
                        });
                    }
                    }
                },
            }          
    }) .mount('#app')

</script>

</body>
</html>


